<!-- 9c75c4b8-522f-4c91-9542-4e28b6ab006c a508cc11-75b0-4cb7-8374-dad7a5591eb7 -->
# Parser Android Maven 适配 - 完全移除 Vert.x

## 项目结构

```
parser-android/  (重命名项目)
├── pom.xml (修改 Maven 坐标和依赖)
└── src/
    └── main/
        └── java/
            └── cn/
                └── qaiu/
                    ├── core/  (新增：核心实现)
                    │   ├── http/
                    │   │   ├── HttpClient.java
                    │   │   └── HttpResponse.java
                    │   └── async/
                    │       ├── Future.java
                    │       └── Promise.java
                    ├── parser/
                    │   ├── impl/  (保持不变)
                    │   ├── IPanTool.java
                    │   └── PanBase.java
                    └── compat/  (兼容层)
                        └── vertx/  (Vert.x API 兼容)
                            ├── core/
                            │   ├── Future.java
                            │   ├── Promise.java
                            │   └── Vertx.java
                            └── ext/
                                └── web/
                                    └── client/
                                        ├── WebClient.java
                                        └── HttpResponse.java
```

## 实现步骤

1. Maven 配置调整

   - 修改项目坐标为 `cn.qaiu:parser-android`
   - 更新版本号和描述
   - 移除 Vert.x 依赖
   - 添加 OkHttp 依赖

2. 核心实现

   - 创建基于 OkHttp 的 HTTP 客户端
   - 实现异步操作基础类（Future/Promise）
   - 实现响应处理和转换

3. 兼容层实现

   - 创建 Vert.x API 兼容包结构
   - 实现兼容层类（保持包名和类名与 Vert.x 一致）
   - 桥接核心实现和兼容层

## 关键代码变更

1. pom.xml 修改:
```xml
<project>
    <groupId>cn.qaiu</groupId>
    <artifactId>parser-android</artifactId>
    <version>10.2.1</version>
    <name>cn.qaiu:parser-android</name>
    <description>Android compatible NFD parser module</description>

    <properties>
        <okhttp.version>4.12.0</okhttp.version>
    </properties>

    <dependencies>
        <!-- 移除 Vert.x 依赖 -->
        <!-- 添加 OkHttp -->
        <dependency>
            <groupId>com.squareup.okhttp3</groupId>
            <artifactId>okhttp</artifactId>
            <version>${okhttp.version}</version>
        </dependency>
        <!-- 保留其他必要依赖 -->
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>${slf4j.version}</version>
        </dependency>
    </dependencies>
</project>
```

2. 核心 HTTP 客户端实现:
```java
package cn.qaiu.core.http;

public class HttpClient {
    private final OkHttpClient client;
    
    public HttpClient() {
        this.client = new OkHttpClient.Builder()
            .followRedirects(false)
            .connectTimeout(30, TimeUnit.SECONDS)
            .readTimeout(30, TimeUnit.SECONDS)
            .writeTimeout(30, TimeUnit.SECONDS)
            .build();
    }
    
    public Future<HttpResponse> request(String method, String url, Map<String, String> headers) {
        Request.Builder requestBuilder = new Request.Builder()
            .url(url);
            
        headers.forEach(requestBuilder::addHeader);
        
        if ("POST".equalsIgnoreCase(method)) {
            requestBuilder.post(RequestBody.create(new byte[0]));
        }
        
        Promise<HttpResponse> promise = Promise.promise();
        client.newCall(requestBuilder.build()).enqueue(new Callback() {
            @Override
            public void onResponse(Call call, Response response) {
                promise.complete(new HttpResponse(response));
            }
            
            @Override
            public void onFailure(Call call, IOException e) {
                promise.fail(e);
            }
        });
        
        return promise.future();
    }
}
```

3. 核心 Future 实现:
```java
package cn.qaiu.core.async;

public class Future<T> {
    private final CompletableFuture<T> delegate = new CompletableFuture<>();
    
    public static <T> Future<T> future() {
        return new Future<>();
    }
    
    public void complete(T result) {
        delegate.complete(result);
    }
    
    public void fail(Throwable cause) {
        delegate.completeExceptionally(cause);
    }
    
    public void onComplete(Handler<AsyncResult<T>> handler) {
        delegate.whenComplete((result, error) -> {
            if (error != null) {
                handler.handle(AsyncResult.failure(error));
            } else {
                handler.handle(AsyncResult.success(result));
            }
        });
    }
    
    public CompletableFuture<T> toCompletableFuture() {
        return delegate;
    }
}
```


## 构建命令

```bash
# 开发构建
mvn clean package

# 发布构建
mvn clean deploy
```

## 测试策略

1. 单元测试

   - HTTP 客户端基本功能
   - Future/Promise 实现
   - 异步操作行为
   - 错误处理机制

2. 集成测试

   - 原有 impl 包下解析器
   - 网络请求处理
   - 响应解析
   - 兼容层功能验证

3. 性能测试

   - 请求延迟对比
   - 内存占用对比
   - 并发处理能力

## 注意事项

1. 保持包名与类名完全一致
2. 确保异步行为与原版一致
3. 处理好超时和重试机制
4. 优化内存使用
5. 保持向后兼容性
6. Maven 坐标变更为 cn.qaiu:parser-android
7. 确保新的 Maven 坐标不与现有项目冲突

### To-dos

- [ ] 创建基础项目结构和 Gradle 配置
- [ ] 实现兼容层（Future、Promise、WebClient）
- [ ] 移植核心接口和基类
- [ ] 设置 impl 目录符号链接并验证兼容性
- [ ] 编写单元测试和集成测试
- [ ] 配置 Maven 发布并准备发布